---
layout: post
title: "ë– ë‚˜ê°„ ë°ì´í„°... ë„ë‚˜í’€ì´ë¼ë„ ì¡ì•„ë³´ì... ğŸ˜± (MySQL binlog)"

tags:
  - MySQL
categories: [ë°ì´í„°ë² ì´ìŠ¤, ë°”ì´ë„ˆë¦¬ ë¡œê·¸]
  
published: true
---

ì–´ëŠ í•œ ë‚ ... í”„ë¡œë•ì…˜ ì„œë²„ *(ì‹¤ìš´ì˜ì€ ì•ˆí•˜ê³  ìˆëŠ” ìƒíƒœ)*ì— ìƒì„±í•´ë†“ì€ ë”ë¯¸ ë°ì´í„°ë“¤ì´ ëª½ë•… ì‚¬ë¼ì§€ëŠ” ì¼ì„ ê²ªì—ˆìŠµë‹ˆë‹¤.  
ë‹¤ì‹œ ì¼ì¼ì´ ë§Œë“¤ê¸°ëŠ” ê·€ì°®ì•„ì„œ ì§‘ ë‚˜ê°„ ë°ì´í„°ë¥¼ ë˜ì°¾ì•„ë³´ëŠ” ì‹œê°„ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.

## ì‚¬ê±´ ì¡°ì‚¬
í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œí•˜ëŠ” ì¹œêµ¬ë¡œë¶€í„° APIê°€ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ë©° ì—°ë½ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.  
ê·¸ë˜ì„œ ë­ì§€? í•˜ë©° JAVA ë¡œê·¸ë¥¼ ë³´ëŠ”ë°... ì¹¼ëŸ¼ì´ ë°œê²¬ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì˜¤ë¥˜ë¥¼ ë³´ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.  
ë‹¹ì¥ DataGripì„ ì—´ê³  DBë¥¼ í™•ì¸í•´ ë´¤ëŠ”ë°.... í……í…… ë¹„ì–´ ìˆë”ë¼ê³ ìš”?????  
ì•„... ëˆ„êµ°ê°€ ë°ì´í„°ë¥¼ ë‚ ë ¸êµ¬ë‚˜... í•˜ê³  ì¶”ì ì— ë‚˜ì„°ìŠµë‹ˆë‹¤... ~~(ì„¤ë§ˆ ë‚œê°€?)~~

ì¼ë‹¨ binlogë¥¼ í™•ì¸ í•´ ë³´ì•˜ìŠµë‹ˆë‹¤. í™•ì¸ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.  
> binlog í´ë”ë¡œ ì´ë™í•˜ì—¬ binlog.000001 í˜•íƒœì˜ íŒŒì¼ í™•ì¸  

```shell
root@localhost:~# cd /var/lib/mysql/

root@localhost:/var/lib/mysql# ls -al

total 104504
drwx------ 10 mysql mysql     4096 Jul 23 00:00  .
drwxr-xr-x 47 root  root      4096 Jun 17 08:25  ..
drwxr-x---  2 mysql mysql     4096 Jul 23 08:17  anabada
-rw-r-----  1 mysql mysql       56 May 28 13:32  auto.cnf
-rw-r-----  1 mysql mysql     2132 Jun 23 00:00  binlog.000036
-rw-r-----  1 mysql mysql     1830 Jun 23 11:38  binlog.000037
-rw-r-----  1 mysql mysql      201 Jun 24 00:00  binlog.000038
-rw-r-----  1 mysql mysql     2756 Jun 25 00:00  binlog.000039
-rw-r-----  1 mysql mysql      201 Jun 26 00:00  binlog.000040
-rw-r-----  1 mysql mysql     3092 Jun 27 00:00  binlog.000041
-rw-r-----  1 mysql mysql     5397 Jun 28 00:00  binlog.000042
-rw-r-----  1 mysql mysql     1057 Jun 29 00:00  binlog.000043
-rw-r-----  1 mysql mysql     2557 Jun 30 00:00  binlog.000044
-rw-r-----  1 mysql mysql      201 Jul  1 00:00  binlog.000045
-rw-r-----  1 mysql mysql    10636 Jul  2 00:00  binlog.000046
-rw-r-----  1 mysql mysql     9793 Jul  3 00:00  binlog.000047
-rw-r-----  1 mysql mysql      201 Jul  4 00:00  binlog.000048
-rw-r-----  1 mysql mysql      201 Jul  5 00:00  binlog.000049
-rw-r-----  1 mysql mysql     3407 Jul  6 00:00  binlog.000050
-rw-r-----  1 mysql mysql      201 Jul  7 00:00  binlog.000051
-rw-r-----  1 mysql mysql     7715 Jul  8 00:00  binlog.000052
-rw-r-----  1 mysql mysql     2847 Jul  9 00:00  binlog.000053
-rw-r-----  1 mysql mysql    13846 Jul 10 00:00  binlog.000054
-rw-r-----  1 mysql mysql     3796 Jul 11 00:00  binlog.000055
-rw-r-----  1 mysql mysql     2384 Jul 11 13:01  binlog.000056
-rw-r-----  1 mysql mysql      201 Jul 12 00:00  binlog.000057
-rw-r-----  1 mysql mysql      201 Jul 13 00:00  binlog.000058
-rw-r-----  1 mysql mysql    17622 Jul 14 00:00  binlog.000059
-rw-r-----  1 mysql mysql     2946 Jul 15 00:00  binlog.000060
-rw-r-----  1 mysql mysql    34372 Jul 16 00:00  binlog.000061
-rw-r-----  1 mysql mysql     8012 Jul 17 00:00  binlog.000062
-rw-r-----  1 mysql mysql     1361 Jul 18 00:00  binlog.000063
-rw-r-----  1 mysql mysql      201 Jul 19 00:00  binlog.000064
-rw-r-----  1 mysql mysql     6082 Jul 20 00:00  binlog.000065
-rw-r-----  1 mysql mysql  2238884 Jul 21 00:00  binlog.000066
-rw-r-----  1 mysql mysql  2256937 Jul 22 00:00  binlog.000067
-rw-r-----  1 mysql mysql    46329 Jul 23 00:00  binlog.000068
-rw-r-----  1 mysql mysql  8412430 Jul 23 08:23  binlog.000069
-rw-r-----  1 mysql mysql      544 Jul 23 00:00  binlog.index
```

ê·¸ëŸ¬ê³  ê°€ì¥ ìµœê·¼ ìƒì„±ëœ binlogë¶€í„° ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.  
![](/assets/2023-07-23/what-is---.jpg)

ìš°ë¦¬ê°€ ì°¾ì•„ì•¼ í•˜ëŠ” `DROP` ì¿¼ë¦¬ë¥¼ ë“œë””ì–´ ì°¾ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.  
ê·¸ëŸ°ë° ë³´ë‹ˆê¹ í…Œì´ë¸” ì¹¼ëŸ¼ì˜ ì£¼ì„ê¹Œì§€ ê°™ì´ `CREATE`ë˜ë”ë¼ê³ ìš”?

![](/assets/2023-07-23/capture_schema-sql.png)
í•´ë‹¹ ì¿¼ë¦¬ì˜ ê·¼ì›ì„ ì°¾ì•„ë³¸ ê²°ê³¼ ì£¼ì„ì´ í¬í•¨ë˜ì–´ ìˆì—ˆê¸° ë•Œë¬¸ì— ddl-autoì˜ ì˜í–¥ì€ ì•„ë‹ˆê³ , schema.sqlì´ ì‹¤í–‰ëœ ê²ƒìœ¼ë¡œ í™•ì¸í–ˆìŠµë‹ˆë‹¤.  
ì €í¬ í”„ë¡œì íŠ¸ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë  ë•Œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ëŒ€í•´ì„œ schema.sqlë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ì´ˆê¸°í™”í•˜ê²Œ í•´ë‘ì—ˆìŠµë‹ˆë‹¤.   
[ì°¸ê³  - ìŠ¤í”„ë§ë¶€íŠ¸ì—ì„œ sql.init.mode=alwaysë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”í• ë•Œ ì£¼ì˜í•´ì•¼ í•  ì ](https://penekhun.github.io/posts/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-sql.init.mode=always-%EC%82%AC%EC%9A%A9%EC%8B%9C-%EC%A3%BC%EC%9D%98%ED%95%B4%EC%95%BC-%ED%95%A0-%EC%A0%90/)  

ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í†µí•´, ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœ ì‹œê°„ì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.  
```shell
mysqlbinlog /var/lib/mysql/binlog.000068
```

í™•ì¸ ê²°ê³¼ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ 1690022381ë¡œ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¥¼ KSTë¡œ ë³€ê²½í•´ ë³´ë‹ˆ...  
![](/assets/2023-07-23/what-time.png){: width="500px"}

23ë…„ 7ì›” 22ì¼ ì˜¤í›„ 7ì‹œ 39ë¶„ìœ¼ë¡œ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.  
~~ê²€ê±° ì™„ë£Œ...(ì¼ë‹¨ ë‚œ ì•„ë‹ˆì˜€ë‹¤. ë‹¤í–‰.)~~  
  
ê·¼ë° ë„ëŒ€ì²´ ì–´ë–»ê²Œ TEST DBê°€ ì•„ë‹Œ ë‹¤ë¥¸ í™˜ê²½ì˜ DBê°€ ë‚ ì•„ê°„ ê±¸ê¹Œìš”?  
  
í”„ë¡œì íŠ¸ì˜ TEST ë¦¬ì†ŒìŠ¤ì˜ application.ymlì„ í™•ì¸í•´ ë³´ë©´ TEST DB ìš© ID, PWë¥¼ í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•´ ë°›ê³  ìˆìŠµë‹ˆë‹¤.
![](/assets/2023-07-23/test_yml.png)

ê·¸ë˜ì„œ ì´ í™˜ê²½ ë³€ìˆ˜ ê°’ì„ ì˜ëª» ì„¤ì •í•œ ê²Œ ì•„ë‹ê¹Œ? ì‹¶ì–´ì„œ í™•ì¸í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.  
![](/assets/2023-07-23/kakaotalk.png){: width="300px"}

~~(ì‚¬ê±´ì¡°ì‚¬ ì™„ë£Œ...)~~

## ì§‘ ë‚˜ê°„ ë°ì´í„° ë³µêµ¬í•´ ë³´ì...!  
ì¼ë‹¨ ìµœì‹  ë²„ì „ì˜ ìŠ¤í‚¤ë§ˆëŠ” Gitì„ í†µí•´ ê´€ë¦¬í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. (ì•„ê¹Œ í™•ì¸í–ˆë˜ `Schema.sql` íŒŒì¼)  
ê·¸ë˜ì„œ í…Œì´ë¸”ì„ ë‹¤ ë°€ì–´ë²„ë¦¬ê³  í•´ë‹¹ `Schema.sql`ë¡œ 1ì°¨ì ìœ¼ë¡œ `DDL`ì„ ë³µêµ¬í•˜ì˜€ìŠµë‹ˆë‹¤.  
  
ì´ì œ ë°ì´í„°ë¥¼ ë³µêµ¬í•´ì•¼ í•  ì°¨ë¡€ì…ë‹ˆë‹¤.  
ê°„ë‹¨í•œ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.  
  
> 1. íŠ¹ì • binlog íŒŒì¼ë“¤ì„ í•˜ë‚˜ì˜. sql íŒŒì¼ë¡œ ìƒì„±í•¨  
> 2. ìƒì„±ëœ. sql íŒŒì¼ì—ì„œ `CREATE TABLE`, `ALTER TABLE`ì˜ ì¿¼ë¦¬ë¥¼ ì£¼ì„ ì²˜ë¦¬í•¨  
> 3. ê¸°íƒ€ ë¶ˆí•„ìš”í•œ ì£¼ì„ ì œê±° (ìƒì„±ëœ ìµœì¢… SQLë¥¼ í™•ì¸í•  ë•Œ ê¹”ë”í•˜ê²Œ í™•ì¸í•  ìˆ˜ ìˆê²Œë”)

```python
import subprocess
import re
import os

def remove_comments(query):
    # binlog ìì²´ë¡œ ìƒê¸´ ì£¼ì„ ì œê±°
    return re.sub(r'(?:/\*.*?\*/|#.*?$|--.*?$)', '', query, flags=re.MULTILINE)

def comment_out_drop_create_queries(query):
    # DROP, ALTER ë¬¸ë²• ì£¼ì„ ì²˜ë¦¬
    return re.sub(r'(?i)^\s*(DROP|ALTER\sTABLE)\s', r'#\g<0>', query, flags=re.MULTILINE)

def extract_binlogs(start_file_number, end_file_number, output_sql_file):
    if os.path.exists(output_sql_file):
        os.remove(output_sql_file)

    mysql_binlog_path = '/usr/bin/mysqlbinlog'  # mysqlbinlog ì‹¤í–‰ íŒŒì¼ ê²½ë¡œë¥¼ í•´ë‹¹ ì‹œìŠ¤í…œì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
    mysql_binlog_directory = '/var/lib/mysql/'  # ì¶”ì¶œí•˜ë ¤ëŠ” binlog íŒŒì¼ë“¤ì´ ìˆëŠ” ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ í•´ë‹¹ ì‹œìŠ¤í…œì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.

    merged_query = ''

    for file_number in range(int(start_file_number), int(end_file_number) + 1):
        binlog_filename = f'binlog.{str(file_number).zfill(6)}'
        binlog_filepath = f'{mysql_binlog_directory}{binlog_filename}'

        try:
            command = f'{mysql_binlog_path} {binlog_filepath}'
            output = subprocess.check_output(command, shell=True, text=True)

            cleaned_output = remove_comments(output)
            cleaned_output = comment_out_drop_create_queries(cleaned_output)

            # ì •ì œëœ ì¿¼ë¦¬ë¥¼ í•©ì³ì¤ë‹ˆë‹¤.
            merged_query += cleaned_output

            print(f'Successfully extracted and cleaned {binlog_filename}')
        except subprocess.CalledProcessError as e:
            print(f'Error extracting {binlog_filename}: {e}')

    # ìµœì¢…ì ìœ¼ë¡œ í•©ì³ì§„ ì¿¼ë¦¬ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    with open(output_sql_file, 'w') as f:
        f.write(merged_query)

if __name__ == '__main__':
    start_file_number = "000000" # íŒŒì‹± ì‹œì‘ íŒŒì¼ ë²ˆí˜¸
    end_file_number = "000067" # íŒŒì‹± ë íŒŒì¼ ë²ˆí˜¸
    output_sql_file = 'output.sql' # ìƒì„±í•  ê²°ê³¼ë¬¼ íŒŒì¼ëª…

    extract_binlogs(start_file_number, end_file_number, output_sql_file)

```
{: file='restore.py'}

ê·¸ëŸ¬ê³  ìƒì„±ëœ output.sql íŒŒì¼ì„ ì§ì ‘ í™•ì¸í•˜ì—¬ ì¼ë¶€ ì¿¼ë¦¬ë“¤ì„ ìˆ˜ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.  
ë§ˆì§€ë§‰ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰ ì‹œì¼œ ì£¼ì—ˆìŠµë‹ˆë‹¤.

```shell
mysql -u root -p -f < ./output.sql
```

![](/assets/2023-07-23/binlog_result.png)
**ë“œë””ì–´.... ì§‘ë‚˜ê°„ ë°ì´í„°ê°€ ëŒì•„ì™”ìŠµë‹ˆë‹¤!!!**  


## ê²°ë¡ 
> 1. ë°±ì—…ì„ ìƒí™œí™” í•˜ì.  
> 	ë””ë¹„ ë°±ì—… ì „ëµ(ì¶”ê°€ ê´€ë¦¬ë¹„ê°€ í•„ìš”ì—†ëŠ” ë°©ë²•)ì€ ì–´ë–¤ ê²ƒì´ ìˆì„ê¹Œ?  
> 	ìŠ¤ì¼€ì¥´ëŸ¬ë¥¼ ë”°ë¡œ êµ¬ì„±í•´ì•¼í• ê¹Œ? í•œë²ˆ ì°¾ì•„ë³´ê³  ë„ì… í•´ ë³´ì•„ì•¼ê² ë‹¤.  
> 1. ë¯¼ê°ì •ë³´ê°€ ë‹´ê¸¸ ìˆ˜ ìˆëŠ” ymlì„ ê´€ë¦¬í•˜ëŠ” ë²•ì„ ì¶”ê°€ë¡œ ìƒê°í•´ë´ì•¼ê² ë‹¤.  